#!/bin/bash -x

set -e

echo Backing up `hostname` on `date -I`

# =============================
# command line flags I'm using:
# =============================
# -C --cvs-exclude (use .cvsignore files to determine what to ignore/skip)
# -a --archive (ALL of the following):
#    -r --recursive (descend subdirectories)
#    -l --links (copy symlinks as symlinks)
#    -p --permissions (copy permissions)
#    -g --group (copy group owner)
#    -o --owner (copy user owner)
#    -D --devices (copy devices intact)
#    -t --times (copy times)
# -v --verbose (show what's happening)
# --inplace  (copy files in place over old files, to reduce i/o)
# --delete (when a file in the destination is missing in the source, delete it
#           in the destination)

# TODO - alternate days

# returns true if s3backup is mounted correctly
isMounted() {
    ROOT_MOUNT=`mountpoint -d /`
    S3BACKUP_MOUNT=`mountpoint -d /mnt/s3backup`
    if mountpoint -q /mnt/s3backup; then
        if [ "$ROOT_MOUNT" != "$S3BACKUP_MOUNT" ]; then
            return 0
        fi
    fi
    return 1
}


ARGS="-Cav --inplace --delete --log-file=/var/log/backup-engraver.log"
## ARGS="-CrlpgoDv --size-only --inplace --delete --log-file=/var/log/backup-engraver.log"
RSYNC="rsync $ARGS"

# this sleep is absolutely necessary because mount is asynchronous and it takes
# a while for jungledisk to connect
if ! isMounted; then mount /mnt/s3backup; sleep 60; fi

echo AFTER MOUNT: ....
mount


if ! isMounted; then
    echo "** Couldn't mount jungledisk; did it fail earlier and keep running?" 1>&2
    PIDS=`pgrep -f jungledisk`
    if [ -n "$PIDS" ]; then 
        echo "$PIDS" | xargs ps -o pid= -o args= -p | xargs -i printf '** %s\n' "{}" 1>&2
    fi
    exit 1
fi


touch /var/log/backup-engraver.log
chmod 600 /var/log/backup-engraver.log

$RSYNC /var /mnt/s3backup/engraver.goonmill.org
$RSYNC /home /mnt/s3backup/engraver.goonmill.org
$RSYNC /etc /mnt/s3backup/engraver.goonmill.org
$RSYNC /usr/local /mnt/s3backup/engraver.goonmill.org/usr
$RSYNC /usr/share/moin /mnt/s3backup/engraver.goonmill.org/usr/share
sync

# don't keep s3backup mounted, less chance of disaster leaking into it
# (e.g. sudo rm -rf /* will happily erase backups too, if they are mounted)
# -z = lazy umount (will work even when resource is in use)
fusermount -z -u /mnt/s3backup
echo "/mnt/s3backup complete and disconnected"

# again, asynchronous, we wait to finish up
sleep 60

# still mounted? that's an error
if isMounted; then exit 1; fi
